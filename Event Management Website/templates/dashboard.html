{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
    <!-- Link to the specific CSS file for this page -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/calendar.css') }}">

    <h1>Welcome, {{ session['user']['username'] }}</h1>

<!-- Event Calendar Section -->
<h2>Your Monthly Calendar</h2>
<div class="calendar-controls">
    <label for="month-select">Month:</label>
    <select id="month-select">
        <option value="0">January</option>
        <option value="1">February</option>
        <option value="2">March</option>
        <option value="3">April</option>
        <option value="4">May</option>
        <option value="5">June</option>
        <option value="6">July</option>
        <option value="7">August</option>
        <option value="8">September</option>
        <option value="9">October</option>
        <option value="10">November</option>
        <option value="11">December</option>
    </select>

    <label for="year-select">Year:</label>
    <select id="year-select"></select>
</div>

</div>


    <div id="calendar"></div> <!-- Placeholder for the calendar -->


    <!-- Modal for Event Details -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="event-title"></h3>
            <p id="event-details"></p>
            <button class="close-modal-btn">Close</button>
        </div>
    </div>

    <!-- Inline JS for calendar generation -->
    <script>
            document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var monthSelect = document.getElementById('month-select');
        var yearSelect = document.getElementById('year-select');

        // Get the current month and year
        var today = new Date();
        var currentMonth = today.getMonth();
        var currentYear = today.getFullYear();

        // Populate the year dropdown (10 years before and after the current year)
        for (var i = currentYear - 5; i <= currentYear + 5; i++) {
            var option = document.createElement('option');
            option.value = i;
            option.text = i;
            yearSelect.appendChild(option);
        }

        // Set the default selected values for the current month and year
        monthSelect.value = currentMonth;
        yearSelect.value = currentYear;

        // Initialize eventsData by combining hosted and attending events, ensuring no duplicates
        var eventsData = [];

        var hostedEvents = [
            {% for event in hosted_events %}
            {
                id: {{ event.id }},
                title: "{{ event.name|escape }}",
                date: "{{ event.date }}",
                time: "{{ event.time }}",
                location: "{{ event.location|escape }}",
                description: "{{ event.description|escape }}"
            },
            {% endfor %}
        ];

        var attendingEvents = [
            {% for event in attending_events %}
            {
                id: {{ event.id }},
                title: "{{ event.name|escape }}",
                date: "{{ event.date }}",
                time: "{{ event.time }}",
                location: "{{ event.location|escape }}",
                description: "{{ event.description|escape }}"
            },
            {% endfor %}
        ];

        // Merge hosted and attending events, filtering out duplicates
        var eventIds = new Set();
        hostedEvents.concat(attendingEvents).forEach(function(event) {
            if (!eventIds.has(event.id)) {
                eventIds.add(event.id);
                eventsData.push(event);
            }
        });

        // Function to generate the calendar for a specific month and year
        function generateCalendar(selectedMonth, selectedYear) {
            var daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
            var firstDay = new Date(selectedYear, selectedMonth, 1).getDay();

            var calendarHTML = '<table class="calendar-table"><thead><tr>';

            // Add the days of the week header
            var daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            daysOfWeek.forEach(function(day) {
                calendarHTML += '<th>' + day + '</th>';
            });

            calendarHTML += '</tr></thead><tbody><tr>';

            // Generate empty cells for days before the 1st of the month
            for (var i = 0; i < firstDay; i++) {
                calendarHTML += '<td></td>';
            }

            // Generate cells for each day of the month
            for (var day = 1; day <= daysInMonth; day++) {
                var dayDate = new Date(selectedYear, selectedMonth, day);
                var formattedDate = dayDate.toISOString().split('T')[0]; // Format: YYYY-MM-DD

                // Check if there are any events on this date
                var dayEvents = eventsData.filter(event => event.date === formattedDate);

                calendarHTML += '<td class="calendar-day">';
                calendarHTML += '<span class="calendar-day-number">' + day + '</span>';

                if (dayEvents.length > 0) {
                    // Display event title directly in the calendar
                    dayEvents.forEach(event => {
                        calendarHTML += `
                            <div class="event-card" data-title="${event.title}" data-description="Time: ${event.time}, Location: ${event.location}">
                                <span class="event-title">${event.title}</span>
                            </div>`;
                    });
                }

                calendarHTML += '</td>';

                // Move to the next row after 7 days
                if ((day + firstDay) % 7 === 0) {
                    calendarHTML += '</tr><tr>';
                }
            }

            calendarHTML += '</tr></tbody></table>';
            calendarEl.innerHTML = calendarHTML;
        }

        // Generate the calendar on page load with the current month and year
        generateCalendar(currentMonth, currentYear);

        // Add event listeners to the dropdowns to regenerate the calendar on change
        monthSelect.addEventListener('change', function() {
            generateCalendar(parseInt(monthSelect.value), parseInt(yearSelect.value));
        });

        yearSelect.addEventListener('change', function() {
            generateCalendar(parseInt(monthSelect.value), parseInt(yearSelect.value));
        });
    });

    </script>

{% endblock %}
